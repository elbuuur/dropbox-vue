<template>
  <div class="flex items-center ml-3 relative">
    <div>
      <button
        @click="toggleUserMenu"
        type="button"
        class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300"
        aria-expanded="false"
        data-dropdown-toggle-trigger
      >
        <span class="sr-only">Open user menu</span>
        <svg
          class="w-8 h-8 p-2 rounded-full"
          width="138"
          height="125"
          viewBox="0 0 138 125"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M129.355 71.9432C127.78 70.3668 126.045 69.0152 124.206 67.8533C124.148 59.8049 123.642 51.6749 122.693 43.6565C122.681 43.5532 122.661 43.4484 122.636 43.3452C121.05 36.9797 116.537 30.2963 110.874 25.0278C113.945 2.48723 110.267 0.909185 108.875 0.316585C107.505 -0.266195 103.909 -1.79531 90.6974 15.2881C76.2353 13.8516 61.6299 13.8516 47.1694 15.2881C33.9607 -1.79081 30.3668 -0.271026 28.9935 0.314914C27.6019 0.907514 23.9165 2.48723 26.991 25.0294C21.3296 30.2979 16.8185 36.9797 15.2322 43.3452C15.2055 43.4484 15.1872 43.5516 15.1756 43.6564C14.2201 51.7564 13.7107 59.973 13.6575 68.1013C11.9729 69.2066 10.3832 70.4833 8.92496 71.9415C8.83507 72.0298 8.79844 72.1446 8.7252 72.2428C3.3535 77.6828 0.200714 85.0853 0.200714 92.884C0.200714 109.096 13.3911 122.286 29.6028 122.286C32.2745 122.286 34.9262 121.923 37.4964 121.207C39.3341 122.088 41.1186 122.746 42.8148 123.17C42.918 123.195 43.0212 123.215 43.1278 123.227C51.6905 124.237 60.3731 124.75 68.9359 124.75C77.4987 124.75 86.1813 124.237 94.7441 123.227C94.8489 123.215 94.9538 123.195 95.057 123.17C96.7733 122.742 98.576 122.075 100.429 121.184C103.029 121.915 105.704 122.286 108.397 122.286C124.609 122.286 137.799 109.096 137.799 92.884C137.799 85.3933 134.91 78.2771 129.934 72.9087C129.811 72.5591 129.636 72.2229 129.355 71.9432ZM106.713 5.4286C107.245 7.95215 107.081 14.316 106.303 21.2657C103.107 18.9669 99.7229 17.1958 96.3887 16.1637C100.311 11.353 104.542 6.82355 106.713 5.4286ZM31.1508 5.43526C33.2166 6.78027 37.3083 11.0384 41.4765 16.1637C38.1422 17.1974 34.7564 18.9686 31.5587 21.2674C30.7813 14.3243 30.6165 7.96215 31.1508 5.43526ZM108.392 117.294C105.872 117.294 103.37 116.903 100.953 116.132C100.322 115.929 99.6363 115.989 99.0487 116.292C97.2743 117.207 95.573 117.88 93.9917 118.289C77.3589 120.239 60.5046 120.239 43.8718 118.289C42.3104 117.885 40.6258 117.221 38.8647 116.317C38.277 116.014 37.5962 115.959 36.9703 116.157C34.5816 116.913 32.1013 117.296 29.5978 117.296C16.1394 117.296 5.18954 106.346 5.18954 92.8874C5.18954 84.2247 9.8671 76.1347 17.3961 71.7717C17.5926 71.6585 17.7707 71.5171 17.9238 71.3589C21.5177 69.3647 25.5711 68.291 29.7942 68.291C36.3478 68.291 42.5052 70.8429 47.1361 75.4738C47.6239 75.9616 48.2631 76.2046 48.9023 76.2046C49.5415 76.2046 50.1807 75.9616 50.6684 75.4738C51.6439 74.4984 51.6439 72.917 50.6684 71.9415C45.0936 66.3651 37.6811 63.2956 29.7958 63.2956C25.9289 63.2956 22.1802 64.043 18.7012 65.4529C18.8344 58.4399 19.2938 51.3802 20.1128 44.4039C22.6746 34.4578 33.9257 23.2083 43.8718 20.6465C44.3729 20.5882 44.8756 20.5466 45.3733 20.4934C46.0558 20.7347 46.8265 20.6665 47.4807 20.277C61.7331 18.8487 76.127 18.8487 90.3794 20.277C91.0336 20.6648 91.8027 20.733 92.4868 20.4917C92.9879 20.5466 93.4923 20.5882 93.9916 20.6465C103.939 23.21 115.189 34.4578 117.751 44.4039C118.565 51.3303 119.024 58.34 119.161 65.3047C115.796 64.0013 112.196 63.2956 108.48 63.2956C100.593 63.2956 93.181 66.3668 87.6062 71.9415C86.6307 72.917 86.6307 74.4984 87.6062 75.4738C88.5817 76.4476 90.1614 76.4476 91.1368 75.4738C95.7678 70.8412 101.927 68.291 108.48 68.291C112.469 68.291 116.306 69.2482 119.748 71.0327C119.948 71.2957 120.184 71.5321 120.479 71.7018C128.078 76.0465 132.799 84.1648 132.799 92.8857C132.8 106.344 121.851 117.294 108.392 117.294ZM49.971 61.6176C49.971 61.7325 49.9654 61.8471 49.9542 61.9614C49.9428 62.0757 49.926 62.1892 49.9036 62.3019C49.8812 62.4146 49.8533 62.5258 49.82 62.6357C49.7866 62.7457 49.7479 62.8537 49.704 62.9598C49.66 63.0659 49.611 63.1696 49.5568 63.2709C49.5027 63.3722 49.4437 63.4707 49.3799 63.5662C49.3161 63.6618 49.2477 63.7539 49.1748 63.8427C49.102 63.9315 49.025 64.0165 48.9438 64.0977C48.8625 64.1789 48.7775 64.256 48.6887 64.3288C48.5998 64.4017 48.5077 64.47 48.4122 64.5338C48.3167 64.5977 48.2183 64.6566 48.1169 64.7108C48.0156 64.765 47.9119 64.814 47.8058 64.858C47.6997 64.9019 47.5917 64.9406 47.4817 64.974C47.3718 65.0073 47.2606 65.0351 47.148 65.0575C47.0352 65.0799 46.9217 65.0968 46.8074 65.1081C46.6931 65.1193 46.5785 65.1249 46.4637 65.1249C46.3488 65.1249 46.2342 65.1193 46.1199 65.1081C46.0056 65.0968 45.8921 65.0799 45.7793 65.0575C45.6667 65.0351 45.5554 65.0073 45.4456 64.974C45.3356 64.9406 45.2276 64.9019 45.1215 64.858C45.0154 64.814 44.9117 64.765 44.8104 64.7108C44.709 64.6566 44.6106 64.5977 44.5151 64.5338C44.4196 64.47 44.3275 64.4017 44.2386 64.3288C44.1498 64.256 44.0648 64.1789 43.9836 64.0977C43.9023 64.0165 43.8253 63.9315 43.7525 63.8427C43.6796 63.7539 43.6112 63.6618 43.5474 63.5662C43.4836 63.4707 43.4246 63.3722 43.3705 63.2709C43.3163 63.1696 43.2673 63.0659 43.2233 62.9598C43.1794 62.8537 43.1407 62.7457 43.1073 62.6357C43.074 62.5258 43.0462 62.4146 43.0237 62.3019C43.0013 62.1892 42.9845 62.0757 42.9731 61.9614C42.9619 61.8471 42.9563 61.7325 42.9563 61.6176C42.9563 61.5028 42.9619 61.3882 42.9731 61.2739C42.9845 61.1596 43.0013 61.0461 43.0237 60.9333C43.0462 60.8207 43.074 60.7094 43.1073 60.5996C43.1407 60.4896 43.1794 60.3815 43.2233 60.2755C43.2673 60.1694 43.3163 60.0656 43.3705 59.9643C43.4246 59.863 43.4836 59.7646 43.5474 59.669C43.6112 59.5736 43.6796 59.4814 43.7525 59.3926C43.8253 59.3038 43.9023 59.2188 43.9836 59.1375C44.0648 59.0563 44.1498 58.9793 44.2386 58.9065C44.3275 58.8336 44.4196 58.7652 44.5151 58.7014C44.6106 58.6376 44.709 58.5786 44.8104 58.5244C44.9117 58.4703 45.0154 58.4212 45.1215 58.3773C45.2276 58.3333 45.3356 58.2947 45.4456 58.2613C45.5555 58.228 45.6667 58.2001 45.7793 58.1777C45.8921 58.1553 46.0056 58.1385 46.1199 58.1273C46.2342 58.116 46.3488 58.1103 46.4637 58.1103C46.5785 58.1103 46.6931 58.116 46.8074 58.1273C46.9217 58.1385 47.0352 58.1553 47.148 58.1777C47.2606 58.2001 47.3719 58.228 47.4817 58.2613C47.5917 58.2947 47.6997 58.3334 47.8058 58.3773C47.9119 58.4212 48.0156 58.4703 48.1169 58.5244C48.2183 58.5786 48.3167 58.6376 48.4122 58.7014C48.5077 58.7652 48.5998 58.8336 48.6887 58.9065C48.7775 58.9793 48.8625 59.0563 48.9438 59.1375C49.025 59.2188 49.102 59.3038 49.1748 59.3926C49.2477 59.4814 49.3161 59.5736 49.3799 59.669C49.4437 59.7646 49.5027 59.863 49.5568 59.9643C49.611 60.0656 49.66 60.1694 49.704 60.2755C49.7479 60.3815 49.7866 60.4896 49.82 60.5996C49.8533 60.7094 49.8812 60.8207 49.9036 60.9333C49.926 61.0461 49.9428 61.1596 49.9542 61.2739C49.9654 61.3882 49.971 61.5028 49.971 61.6176ZM94.9105 61.6176C94.9105 61.7325 94.9049 61.8471 94.8937 61.9614C94.8824 62.0757 94.8655 62.1892 94.8431 62.3019C94.8207 62.4146 94.7928 62.5258 94.7596 62.6357C94.7262 62.7457 94.6875 62.8537 94.6436 62.9598C94.5996 63.0659 94.5505 63.1696 94.4964 63.2709C94.4422 63.3722 94.3832 63.4707 94.3194 63.5662C94.2556 63.6618 94.1873 63.7539 94.1143 63.8427C94.0415 63.9315 93.9645 64.0165 93.8833 64.0977C93.8021 64.1789 93.7171 64.256 93.6283 64.3288C93.5395 64.4017 93.4474 64.47 93.3518 64.5338C93.2563 64.5977 93.1578 64.6566 93.0565 64.7108C92.9552 64.765 92.8515 64.814 92.7454 64.858C92.6393 64.9019 92.5313 64.9406 92.4213 64.974C92.3114 65.0073 92.2002 65.0351 92.0875 65.0575C91.9748 65.0799 91.8613 65.0968 91.7469 65.1081C91.6326 65.1193 91.5181 65.1249 91.4032 65.1249C91.2883 65.1249 91.1738 65.1193 91.0595 65.1081C90.9452 65.0968 90.8317 65.0799 90.7189 65.0575C90.6063 65.0351 90.495 65.0073 90.3851 64.974C90.2752 64.9406 90.1671 64.9019 90.061 64.858C89.9549 64.814 89.8512 64.765 89.7499 64.7108C89.6486 64.6566 89.5502 64.5977 89.4546 64.5338C89.3591 64.47 89.2669 64.4017 89.1781 64.3288C89.0894 64.256 89.0043 64.1789 88.9231 64.0977C88.8419 64.0165 88.7648 63.9315 88.692 63.8427C88.6191 63.7539 88.5508 63.6618 88.487 63.5662C88.4232 63.4707 88.3642 63.3722 88.31 63.2709C88.2559 63.1696 88.2068 63.0659 88.1629 62.9598C88.1189 62.8537 88.0803 62.7457 88.0469 62.6357C88.0136 62.5258 87.9857 62.4146 87.9633 62.3019C87.9409 62.1892 87.924 62.0757 87.9127 61.9614C87.9015 61.8471 87.8959 61.7325 87.8959 61.6176C87.8959 61.5028 87.9015 61.3882 87.9127 61.2739C87.924 61.1596 87.9409 61.0461 87.9633 60.9333C87.9857 60.8207 88.0136 60.7094 88.0469 60.5996C88.0803 60.4896 88.1189 60.3815 88.1629 60.2755C88.2068 60.1694 88.2559 60.0656 88.31 59.9643C88.3642 59.863 88.4232 59.7646 88.487 59.669C88.5508 59.5736 88.6191 59.4814 88.692 59.3926C88.7648 59.3038 88.8419 59.2188 88.9231 59.1375C89.0043 59.0563 89.0894 58.9793 89.1781 58.9065C89.2669 58.8336 89.3591 58.7652 89.4546 58.7014C89.5502 58.6376 89.6486 58.5786 89.7499 58.5244C89.8512 58.4703 89.9549 58.4212 90.061 58.3773C90.1671 58.3333 90.2752 58.2947 90.3851 58.2613C90.495 58.228 90.6063 58.2001 90.7189 58.1777C90.8317 58.1553 90.9452 58.1385 91.0595 58.1273C91.1738 58.116 91.2883 58.1103 91.4032 58.1103C91.5181 58.1103 91.6326 58.116 91.7469 58.1273C91.8612 58.1385 91.9748 58.1553 92.0875 58.1777C92.2002 58.2001 92.3114 58.228 92.4213 58.2613C92.5313 58.2947 92.6393 58.3334 92.7454 58.3773C92.8515 58.4212 92.9552 58.4703 93.0565 58.5244C93.1578 58.5786 93.2563 58.6376 93.3518 58.7014C93.4474 58.7652 93.5395 58.8336 93.6283 58.9065C93.7171 58.9793 93.8021 59.0563 93.8833 59.1375C93.9645 59.2188 94.0415 59.3038 94.1143 59.3926C94.1873 59.4814 94.2556 59.5736 94.3194 59.669C94.3832 59.7646 94.4422 59.863 94.4964 59.9643C94.5506 60.0656 94.5996 60.1694 94.6436 60.2755C94.6875 60.3815 94.7262 60.4896 94.7596 60.5996C94.7928 60.7094 94.8207 60.8207 94.8431 60.9333C94.8655 61.0461 94.8824 61.1596 94.8937 61.2739C94.9049 61.3882 94.9105 61.5028 94.9105 61.6176ZM75.4812 100.556L75.065 100.972C74.0413 101.136 73.0941 101.175 72.7179 101.152C72.2318 100.878 71.2414 100.06 71.0067 99.7706C70.6971 99.3178 70.6588 99.2595 70.6588 98.5587V92.7326C73.6784 91.6206 76.5449 87.4957 76.5449 84.5627C76.5449 83.1827 75.4262 82.0657 74.0479 82.0657C72.6696 82.0657 71.551 83.1827 71.551 84.5627C71.551 85.5381 69.8831 87.6588 69.0058 88.0334H67.3246C66.4473 87.6572 64.7794 85.5381 64.7794 84.5627C64.7794 83.1827 63.6607 82.0657 62.2824 82.0657C60.9041 82.0657 59.7855 83.1827 59.7855 84.5627C59.7855 87.4957 62.647 91.614 65.6649 92.7292V99.2262C65.074 100.01 64.4698 100.664 64.1735 100.934C63.6108 101.076 62.3174 101.184 61.9579 101.141C61.3619 101.014 61.2853 100.997 60.8426 100.556C59.8671 99.5808 58.2874 99.5808 57.3119 100.556C56.3365 101.53 56.3365 103.113 57.3119 104.087C58.8001 105.575 60.0252 105.835 60.9208 106.026C61.2188 106.089 61.6999 106.128 62.2725 106.128C63.744 106.128 65.8115 105.88 66.8585 105.167C67.263 104.893 67.7241 104.45 68.1852 103.962C69.1856 104.854 70.519 105.805 71.5644 106.026C71.9722 106.113 72.4749 106.149 73.0226 106.149C74.2477 106.149 75.6976 105.963 76.8029 105.728C77.274 105.627 77.7068 105.392 78.048 105.051L79.0118 104.087C79.9873 103.113 79.9873 101.53 79.0118 100.556C78.0364 99.5808 76.455 99.5808 75.4812 100.556Z"
            fill="#FFB500"
          />
        </svg>
      </button>
    </div>
    <div
      v-if="isOpenUserMenu"
      class="right-0 absolute top-6 z-50 my-4 text-base list-none bg-white divide-y divide-gray-100 rounded shadow"
      data-dropdown-toggle-menu
    >
      <div class="px-4 py-3" role="none">
        <p class="text-sm text-gray-900" role="none">
          {{ userData.name }}
        </p>
        <p class="text-sm font-medium text-gray-900 truncate" role="none">
          {{ userData.email }}
        </p>
      </div>
      <ul class="py-1" role="none">
        <li>
          <a
            href="#"
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
            role="menuitem"
            >Settings</a
          >
        </li>
        <li>
          <a
            @click="userStore.logoutUser()"
            href="#"
            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
            role="menuitem"
            >Sign out</a
          >
        </li>
      </ul>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount } from "vue";

import { useUserStore } from "@/stores/user";
import { useEventListener } from "@/composables/useEventListener";

const userStore = useUserStore();
const isOpenUserMenu = ref(false);

if (userStore.userData.email.length < 1) {
  userStore.fetchUserData();
}

const userData = userStore.getUser;

const handleClickOutside = (event: MouseEvent) => {
  const activeTrigger = (event.target as HTMLElement).closest(
    "[data-dropdown-toggle-trigger]"
  );
  const menuPanel = (event.target as HTMLElement).closest(
    "[data-dropdown-toggle-menu]"
  );

  if (isOpenUserMenu.value && !activeTrigger && !menuPanel) {
    isOpenUserMenu.value = false;
  }
};

useEventListener(document, "click", handleClickOutside);

const toggleUserMenu = () => {
  isOpenUserMenu.value = !isOpenUserMenu.value;
};
</script>
